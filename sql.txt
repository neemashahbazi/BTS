mysql> create database db_bts; -- Create the new database
mysql> create user 'root'@'localhost' identified by '123456'; -- Creates the user
mysql> grant all on db_bts.* to 'root'@'localhost'; -- Gives all the privileges to the new user on the newly created database



CREATE  TABLE db_bts.u_users (
  username VARCHAR(20) NOT NULL ,
  password VARCHAR(100) NOT NULL ,
  enabled TINYINT NOT NULL DEFAULT 1 ,
  PRIMARY KEY (username));

  Drop Table db_bts.u_users;

  INSERT INTO db_bts.u_users(username,password,enabled) VALUES ('trader','$2a$04$Oo0LB/rtiBUb161fFYJo0ObSn7Bn/5y2RX/.vYIdi3uM4u0BBmTw6', true);
    INSERT INTO db_bts.u_users(username,password,enabled) VALUES ('trader2','trader', true);
  INSERT INTO db_bts.u_users(username,password,enabled) VALUES ('client','$2a$04$4WEWaIgugxe2PWY0yo9Wv.Fz4IaAgkI8hz7ne2.0y2ZRGh7Bj4iWu', true);
  INSERT INTO db_bts.u_users(username,password,enabled) VALUES ('client2','client', true);
  INSERT INTO db_bts.u_users(username,password,enabled) VALUES ('manager','manager', true);

  CREATE TABLE db_bts.u_roles (
    id int(11) NOT NULL AUTO_INCREMENT,
    username varchar(20) NOT NULL,
    role varchar(20) NOT NULL,
    PRIMARY KEY (id),
    UNIQUE KEY uni_username_role (role,username),
    KEY fk_username_idx (username),
    CONSTRAINT fk_username FOREIGN KEY (username) REFERENCES db_bts.u_users (username));

      Drop Table db_bts.u_roles;



INSERT INTO db_bts.u_roles(username, role) VALUES ('trader', 'TRADER');
INSERT INTO db_bts.u_roles (username, role) VALUES ('client', 'CLIENT');
INSERT INTO db_bts.u_roles(username, role) VALUES ('trader2', 'TRADER');
INSERT INTO db_bts.u_roles (username, role) VALUES ('client2', 'CLIENT');
INSERT INTO db_bts.u_roles (username, role) VALUES ('manager', 'MANAGER');



CREATE TABLE db_bts.u_traders (
   username VARCHAR(20) NOT NULL,
   PRIMARY KEY (username),
   KEY fk_username_user (username),
  CONSTRAINT fk_username_user FOREIGN KEY (username) REFERENCES db_bts.u_users (username));

    Drop Table db_bts.u_traders;


INSERT INTO db_bts.u_traders(username) VALUES ('trader');
INSERT INTO db_bts.u_traders(username) VALUES ('trader2');


  CREATE TABLE db_bts.u_level (
       id int(11) NOT NULL AUTO_INCREMENT,
       name VARCHAR(20) NOT NULL,
       percentage  DOUBLE,
       PRIMARY KEY (id));

                INSERT INTO db_bts.u_level(name, percentage) VALUES ("GOLD", 0.3);
                INSERT INTO db_bts.u_level(name, percentage) VALUES ("SILVER", 0.5);

         Drop Table db_bts.u_level;




CREATE TABLE db_bts.u_clients (
     id int(11) NOT NULL AUTO_INCREMENT,
     username VARCHAR(20) NOT NULL,
     firstname VARCHAR(30) NOT NULL,
     lastname VARCHAR(30) NOT NULL,
     phone_num VARCHAR(10) ,
	 cellphone_num VARCHAR(10) ,
	 email VARCHAR(30),
	 level int DEFAULT 2,
	 bitcoin_bal DOUBLE DEFAULT 0,
	 fiat_currency DOUBLE DEFAULT 0,
	 trader_username  VARCHAR(20) NOT NULL,
	 street VARCHAR(30),
	 city VARCHAR(30),
	 state VARCHAR(30),
	 zipcode CHAR(5),
     PRIMARY KEY (id),
      CONSTRAINT fk_client_user FOREIGN KEY (username) REFERENCES db_bts.u_users (username),
     CONSTRAINT fk_trader FOREIGN KEY (trader_username) REFERENCES db_bts.u_traders (username),
     CONSTRAINT fk_level FOREIGN KEY (level) REFERENCES db_bts.u_level (id));

     INSERT INTO db_bts.u_clients (username,firstname,lastname,phone_num,cellphone_num,email,level,bitcoin_bal,fiat_currency,trader_username,street,city,state,zipcode)
     VALUES ('client','Pooneh','mousavi','95467234','234234','p.mousavi@gmail.com',2,12000001,120000000,'trader','19251 preston rd','dallas','texas','75252');
          INSERT INTO db_bts.u_clients (username,firstname,lastname,phone_num,cellphone_num,email,level,bitcoin_bal,fiat_currency,trader_username,street,city,state,zipcode)
          VALUES ('client2','Nima','shahbazi','95467234','234234','p.mousavi@gmail.com','SILVER',120,100,'trader2','19251 preston rd','dallas','texas','75252');

  Drop Table db_bts.u_clients;








CREATE TABLE trx_transactions (
     id int(11) NOT NULL AUTO_INCREMENT,
     date DATE NOT NULL,
     time TIME NOT NULL,
     date_time TIMESTAMP NOT NULL,
     amount DOUBLE,
     trx_type varchar(30) NOT NULL,
     fiat_amount DOUBLE,
     commission_amount DOUBLE,
     commission_type varchar(11),
     client_id  int(11) NOT NULL,
     trader_username  VARCHAR(20),
     PRIMARY KEY (id),
     CONSTRAINT fk_trx_client FOREIGN KEY (client_id) REFERENCES db_bts.u_clients (id),
     CONSTRAINT fk_trx_trader FOREIGN KEY (trader_username) REFERENCES db_bts.u_traders (username));

     DROP TABLE trx_transactions;


     CREATE TABLE trx_audit (
          id int(11) NOT NULL AUTO_INCREMENT,
          deleted_date TIMESTAMP NOT NULL,
          amount DOUBLE,
          trx_type varchar(30) NOT NULL,
          fiat_amount DOUBLE,
          commission_amount DOUBLE,
          commission_type varchar(11),
          client_id  int(11) NOT NULL,
          deleted_by  VARCHAR(20),
          PRIMARY KEY (id),
          CONSTRAINT fk_trx_audit_client FOREIGN KEY (client_id) REFERENCES db_bts.u_clients (id),
          CONSTRAINT fk_trx_deletedtby FOREIGN KEY (deleted_by) REFERENCES db_bts.u_traders (username));

DELIMITER //
CREATE TRIGGER transaction_after_delete
AFTER DELETE
   ON trx_transactions FOR EACH ROW

BEGIN



   INSERT INTO trx_audit
   (      id ,
          deleted_date,
          amount ,
          trx_type,
          fiat_amount,
          commission_amount,
          commission_type,
          client_id ,
          deleted_by)
   VALUES
   ( OLD.id,
     SYSDATE(),
     OLD.amount,
     OLD.trx_type,
     OLD.fiat_amount,
     OLD.commission_amount,
     OLD.commission_type,
     OLD.client_id ,
     OLD.trader_username );

END; //

DELIMITER ;


